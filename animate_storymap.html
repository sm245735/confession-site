<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Story Map</title>
  <!-- æŒ‡å®šç¶²è·¯ä¸Šçš„ favicon -->
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/sm245735/confession-site@main/favicon.ico" type="image/png"> 
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>

        /* 1. ç™»å…¥å€å¡Šå°ˆå±¬æ¨£å¼ï¼Œä¸å½±éŸ¿å…¶ä»–å€åŸŸ */
    #login-screen {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #FFEDE2, #FFF9F3);
      font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      z-index: 100;
    }
    #login-screen .login-box {
      width: 300px;
      padding: 30px;
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      text-align: center;
    }
    #login-screen input {
      width: 100%;
      padding: 10px;
      margin: 12px 0;
      border: 1.5px solid #FFD1D1;
      border-radius: 8px;
    }
    #login-screen button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #FF8C94;
      color: #fff;
      cursor: pointer;
      transition: background .2s;
    }
    #login-screen button:hover {
      background: #FF6F61;
    }
    #login-screen .error {
      color: #E05A63;
      display: none;
      margin-top: 8px;
      font-size: 14px;
    }

    /* 2. ä¸»ç•«é¢ï¼ˆåœ°åœ–ï¼‹å¡ç‰‡ï¼‰é è¨­éš±è— */
    #main-screen {
      display: none;
      height: 100vh;
      margin: 0;
      padding: 0;
      /* ä½ å¯ä»¥åœ¨é€™è£¡åŠ ä¸Šåœ°åœ–æˆ–å¡ç‰‡çš„å…¨åŸŸä½ˆå±€èƒŒæ™¯ */
    }
    #map { height: 100vh; width: 100vw; z-index: 0; }
    .story-card {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 999;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      max-width: 550px;
      /*max-height: 80vh;*/
      display: none;
    }
    .story-card.active {
      display: block;
    }
    /* æ‰‹æ©Ÿï¼ˆæˆ– max-width â‰¤ 768pxï¼‰æ™‚ï¼Œå¡ç‰‡æœ€å¤§å¯¬åº¦ 200pxï¼Œä¸¦ç½®ä¸­ */
    @media (max-width: 768px) {
  	.story-card {
    	     max-width: 250px;
	     margin: 0 auto;    /* è‡ªå‹•å·¦å³ç½®ä¸­ */
 	    /*bottom: -10px!important;*/
        }
    .toggle-btn {
        /* å›ºå®šå¯¬é«˜ï¼Œè‡³å°‘ 44px */
        width: 33px;
        height: 33px;
        /* æ–‡å­—å¤§å°ä¹Ÿä¸€èµ·æ”¾å¤§ */
        font-size: 1.25rem;  /* ç´„ 20px */
        /* ç½®ä¸­å°é½Š icon */
        display: flex;
        justify-content: center;
        align-items: center;
        /* å¢åŠ é»æ“Šç¯„åœ */
        padding: 0;
      }
    /* è®“ .arrow å¯ä»¥è¢«æ—‹è½‰ */
    .toggle-btn .arrow {
      display: inline-block;               /* transform ç”Ÿæ•ˆ */
      transition: transform .3s ease;      /* å¹³æ»‘éæ¸¡ */
      font-size: 1rem;                  /* è¦–éœ€æ±‚èª¿æ•´å¤§å° */
      line-height: 1;                      /* é¿å…è¡Œé«˜å¹²æ“¾ */
    }
    
    /* aria-expanded="false" æ™‚ï¼Œç®­é ­å¾€å³ */
    .toggle-btn[aria-expanded="false"] .arrow {
      transform: rotate(-90deg);
      height: 88px !important;
    	}
    }
   /* ç­†é›»æ™‚å†è®Šçª„ä¸€é» */
   @media (max-height: 700px) {
  	.story-card {
	    padding: 12px;         /* ç¸®å°å…§é‚Šè· */
	    font-size: 0.9rem;     /* ç¸®å°å­—é«” */
            max-width: 25%;      /* å†é€²ä¸€æ­¥é™ä½é«˜åº¦ä¸Šé™ */
     }
   }
	  
    .entry-icon {
	vertical-align: middle;  /* è·Ÿæ–‡å­—åŒä¸€åŸºç·š */
	margin-right: 6px;        /* åœ–æ¨™èˆ‡æ–‡å­—ä¹‹é–“ç©ºé–“ */ 
    }
    .entry-title {
        font-size: 18px;
        color: #333;  
	display: inline-flex;
        align-items: center;      /* å…§éƒ¨å­é …å‚ç›´ç½®ä¸­ */
    }
  </style>
</head>
<body>

  <!-- ç™»å…¥å€ -->
  <div id="login-screen">
    <div class="login-box">
      <h2>å°ˆå±¬å¯†ç¢¼é– ğŸ”’</h2>
      <input type="password" id="password" placeholder="è«‹è¼¸å…¥å°ç§˜å¯†">
      <button onclick="doLogin()">é€²å…¥æ—¥è¨˜</button>
      <div class="error" id="err">å¯†ç¢¼éŒ¯èª¤ï¼Œå†è©¦ä¸€æ¬¡ï½</div>
    </div>
  </div>
    
    <!-- ä¸»ç•«é¢ï¼šåœ°åœ– + å¡ç‰‡ -->
    <div id="main-screen">
       <div id="map"></div>
       <div id="story-container"></div>
    </div>
  <script>

    // å‡è¨­å°æ–¼ç­‰æ–¼ 768px æˆ‘å€‘å°±ç•¶æˆæ‰‹æ©Ÿ
    const isMobile = window.innerWidth <= 768;
    const centerLat = isMobile ? 24 : 23.8;
    const Level = isMobile ? 7 : 8;
    const larger_style = isMobile ? "" : "style=\"font-size: 1.2rem;\"";
    
    const map = L.map('map').setView([centerLat, 121], Level);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap è²¢ç»è€…'
    }).addTo(map);


    // ç™»å…¥ç›¸é—œç¨‹å¼
    function doLogin() {
      const pass = document.getElementById("password").value;
      const validPass = "1131229";  // æ”¹æˆä½ çš„å¯†ç¢¼

      if (pass === validPass) {
        // éš±è—ç™»å…¥ã€é¡¯ç¤ºä¸»ç•«é¢
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("main-screen").style.display = "block";

         // 2. ç­‰ä¸€ä¸‹å†é‡ç®—åœ°åœ–å¤§å°
        setTimeout(() => {
            map.invalidateSize(true);
        }, 200);

      } else {
        document.getElementById("err").style.display = "block";
      }
    }

    // æ”¯æ´æŒ‰ Enter éµç™»å…¥
    document.getElementById("password")
      .addEventListener("keydown", e => {
        if (e.key === "Enter") doLogin();
      });

    

    const icons = {
      arrow: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/4439/4439420.png', iconSize: [40, 40]}),
      eat: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/1531/1531385.png', iconSize: [40, 40] }),
      walk: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/2591/2591439.png', iconSize: [40, 40] }),
      health: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/2382/2382461.png', iconSize: [40, 40] })
    };

    function createCard(card, index) {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'story-card';
      cardDiv.id = `card-${index}`;

      // 2025.05.11 å–å¾—ç…§ç‰‡æ–¹å¼æ”¹ä»¥github workflow
      const owner  = 'sm245735';
      const repo   = 'confession-site';
      const branch = 'main';

      // Helperï¼šçµ¦å®š folderName è·Ÿ image æª”åï¼Œå›å‚³å®Œæ•´ raw URL
      function makeRawUrl(folderName, fileName) {
	      // let raw_url = `https://cdn.jsdelivr.net/gh/${owner}/${repo}@main/images/${encodeURIComponent(folderName)}/${encodeURIComponent(fileName)}`;
	      let raw_url = `./images/${encodeURIComponent(folderName)}/${encodeURIComponent(fileName)}`;
         return raw_url;
      }
      // æ‹‰å–åœ–ç‰‡æ¸…å–® JSON
      //const jsonUrl = `https://cdn.jsdelivr.net/gh/${owner}/${repo}@main/image-list/${encodeURIComponent(card.folderName)}.json`;
      const jsonUrl = `./image-list/${encodeURIComponent(card.folderName)}.json`;
	    let imgs  ='';
	  fetch(jsonUrl)
	    .then(res => {
	      if (!res.ok) throw new Error(`è®€å– JSON å¤±æ•— ${res.status}`);
	      return res.json();
	    })
	    .then(files => {
	      // æŠŠæª”åé™£åˆ—è½‰æˆ <div class="swiper-slide"><img â€¦></div> å­—ä¸²
	      imgs = files
	        .map(name => `<div class="swiper-slide">
	                         <img src="${makeRawUrl(card.folderName, name)}" class="w-full">
	                       </div>`)
		     
	        .join('');
	      cardDiv.innerHTML = `
	<div class="card-header p-4 flex justify-between items-center">
	    <h2 class="text-lg font-bold entry-title">
		<a href="javascript:;" onclick="if(confirm('ç¢ºå®šè¦å‰å¾€ï¼Ÿ')) window.open('${card.google_map_link}', '_blank')"
		   class="inline-flex items-center space-x-2"
		>
		<img src="https://cdn-icons-png.flaticon.com/512/1865/1865269.png" alt="ğŸ“Œ" class="ew-5 h-5 flex-shrink-0">
                &nbsp;
		${card.title}
		</a>
	</h2>
	    <!-- æ”¶åˆæŒ‰éˆ• -->
	    <button class="toggle-btn text-gray-500 hover:text-gray-800 focus:outline-none" aria-expanded="true" aria-label="æ”¶åˆï¼å±•é–‹">
	       <span class="arrow">â–¼</span>
	    </button>
	  </div>
	<div class="card-body overflow-hidden transition-max-h duration-300 max-h-[1000px]">
        	<div class="swiper">
	          <div class="swiper-wrapper">${imgs}</div>
        	  <div class="swiper-pagination"></div>
	        </div>
        	<div class="p-4">

	          <p class="text-sm text-gray-500" ${larger_style} >${card.time} | ${card.subtitle}</p>
        	  <p class="mt-2 text-sm" ${larger_style}>${card.content}</p>
	        </div>
	</div>
      `;
      document.getElementById('story-container').appendChild(cardDiv);
	    });
      
      // æ”¯æ´çµ•å°èˆ‡ç›¸å°è·¯å¾‘ï¼Œä¸¦ç§»é™¤éŒ¯èª¤å‰ç¶´
      //const imgs = card.images.split('|').map(img => {
      //  const raw = img.replace(/^img\//, '');
      //  const src = /https?:\/\//.test(raw) ? raw : `img/${raw}`;
      //  return `<div class="swiper-slide"><img src="${src}" class="w-full"></div>`;
      // }).join('');

      
    }

    function showCard(index) {
      document.querySelectorAll('.story-card').forEach(el => el.classList.remove('active'));
      const target = document.getElementById(`card-${index}`);
      if (target) target.classList.add('active');
    }

    fetch('./data/diary.csv')
      .then(res => res.text())
      .then(csvText => {
        Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          complete: function(results) {
            const rows = results.data.filter(r => r.lat && r.lng);
            rows.forEach((row, index) => {
              const marker = L.marker([row.lat, row.lng], { icon: icons[row.type] || icons.walk }).addTo(map);
              marker.on('click', () => showCard(index));
              createCard(row, index);
            });

            setTimeout(() => {
              document.querySelectorAll('.swiper').forEach(swiperEl => {
                new Swiper(swiperEl, {
                  autoHeight: true, // è‡ªå‹•èª¿æ•´é«˜åº¦
                  loop: true,
                  pagination: { el: swiperEl.querySelector('.swiper-pagination') }
                });
              });
              showCard(0);
            }, 100);
          }
        });
      });
    // 1. åœ¨åˆå§‹åŒ–éšæ®µå°±åŠ ä¸€æ¬¡
    const container = document.getElementById('story-container');
    container.addEventListener('click', e => {
      // æ‰¾æœ€è¿‘çš„ toggle-btn ï¼ˆæ”¯æ´é»åˆ°è£¡é¢æ–‡å­—æ™‚ä¹Ÿèƒ½æŠ“åˆ°ï¼‰
      const btn = e.target.closest('.toggle-btn');
      if (!btn) return;
    
      // å†æ‰¾å‡ºé€™å€‹æŒ‰éˆ•çš„å¡ç‰‡èˆ‡å…§å®¹å€
      const card = btn.closest('.story-card');
      const body = card.querySelector('.card-body');
      const expanded = btn.getAttribute('aria-expanded') === 'true';
    
      if (expanded) {
        body.classList.add('max-h-0');
        btn.textContent = 'â–º';
        btn.setAttribute('aria-expanded', 'false');
      } else {
        body.classList.remove('max-h-0');
        btn.textContent = 'â–¼';
        btn.setAttribute('aria-expanded', 'true');
      }
    });
  </script>
</body>
</html>

