<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Story Map</title>
  <!-- æŒ‡å®šç¶²è·¯ä¸Šçš„ favicon -->
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/sm245735/confession-site@main/favicon.ico" type="image/png"> 
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <link rel="stylesheet" href="./css/login.css" />
  <link rel="stylesheet" href="./css/card.css" />
  <link rel="stylesheet" href="./css/map.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div id="login-screen">
	<div class="login-box">
		<h2>å°ˆå±¬å¯†ç¢¼é– ğŸ”’</h2><input id="password" placeholder="è«‹è¼¸å…¥å°ç§˜å¯†" type="password"> <button onclick="doLogin()">é€²å…¥æ—¥è¨˜</button>
		<div class="error" id="err">
			å¯†ç¢¼éŒ¯èª¤ï¼Œå†è©¦ä¸€æ¬¡ï½
		</div>
	</div>
</div>
<div id="main-screen">
	<div id="map"></div>
	<div id="story-container"></div>
</div><!-- ç¯©é¸é¢æ¿ -->
<div class="hidden absolute top-14 left-4 z-50 bg-white p-4 rounded shadow w-64 max-h-[70vh] overflow-auto filter-panel" id="filter-panel">
	<input class="w-full mb-2 p-2 border rounded" id="filter-input" placeholder="è¼¸å…¥ç¯©é¸é—œéµå­—â€¦" type="text">
	<div class="text-sm space-y-2" id="filter-results">
		<!-- é€™è£¡æœƒå‹•æ…‹å¡«å…¥åˆ†çµ„å¾Œçš„ <details>â€¦</details> -->
	</div>
</div>
<script>
  	// å‡è¨­å°æ–¼ç­‰æ–¼ 768px æˆ‘å€‘å°±ç•¶æˆæ‰‹æ©Ÿ
	const isMobile = window.innerWidth <= 768;
	const centerLat = isMobile ? 24 : 23.8;
	const Level = isMobile ? 7 : 8;
	const larger_style = isMobile ? "" : "style=\"font-size: 1.2rem;\"";
	const map = L.map('map').setView([centerLat, 121], Level);
	L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		attribution: 'Â© OpenStreetMap è²¢ç»è€…'
	}).addTo(map);
	// å®£å‘Šè³‡æ–™å…¨åŸŸè®Šæ•¸
	window.locdata = [];
	window.locmarkers = [];
	// ç™»å…¥ç›¸é—œç¨‹å¼
	function doLogin() {
		const pass = document.getElementById("password").value;
		const validPass = "1131229"; // æ”¹æˆä½ çš„å¯†ç¢¼
		if (pass === validPass) {
			// éš±è—ç™»å…¥ã€é¡¯ç¤ºä¸»ç•«é¢
			document.getElementById("login-screen").style.display = "none";
			document.getElementById("main-screen").style.display = "block";
			// 2. ç­‰ä¸€ä¸‹å†é‡ç®—åœ°åœ–å¤§å°
			setTimeout(() => {
				map.invalidateSize(true);
			}, 200);
		} else {
			document.getElementById("err").style.display = "block";
		}
	}
	// æ”¯æ´æŒ‰ Enter éµç™»å…¥
	document.getElementById("password").addEventListener("keydown", e => {
		if (e.key === "Enter") doLogin();
	});
	// åœ°åœ–icon
	const icons = {
		arrow: L.icon({
			iconUrl: 'https://cdn-icons-png.flaticon.com/512/4439/4439420.png',
			iconSize: [40, 40]
		}),
		eat: L.icon({
			iconUrl: 'https://cdn-icons-png.flaticon.com/512/3109/3109780.png',
			iconSize: [40, 40]
		}),
		walk: L.icon({
			iconUrl: 'https://cdn-icons-png.flaticon.com/512/2591/2591439.png',
			iconSize: [40, 40]
		}),
		health: L.icon({
			iconUrl: 'https://cdn-icons-png.flaticon.com/512/2382/2382461.png',
			iconSize: [40, 40]
		}),
		buy: L.icon({
			iconUrl: 'https://cdn-icons-png.flaticon.com/512/9284/9284424.png',
			iconSize: [40, 40]
		}),
		bubbleTea: L.icon({
			iconUrl: 'https://cdn-icons-png.flaticon.com/512/3081/3081162.png',
			iconSize: [40, 40]
		}),
		motorcycle: L.icon({
			iconUrl: 'https://cdn-icons-png.flaticon.com/512/1023/1023346.png',
			iconSize: [40, 40]
		}),
	};
	
	function IconNameMaper(eng_name) {
		let chi_name = 'å°šæœªå®šç¾©';
		if (eng_name == "arrow") {
			chi_name = 'å°„ç®­';
		}
		if (eng_name == "eat") {
			chi_name = 'é£¯é£¯';
		}
		if (eng_name == "walk") {
			chi_name = 'é€›é€›';
		}
		if (eng_name == "health") {
			chi_name = 'å¥åº·';
		}
		if (eng_name == "buy") {
			chi_name = 'è²·è²·è²·';
		}
		if (eng_name == "bubbleTea") {
			chi_name = 'å¥¶èŒ¶';
		}
		if (eng_name == "motorcycle") {
			chi_name = 'è»Šè»Š';
		}
		return chi_name;
	}
	// ç”¨ forEachå–å‡ºiconèˆ‡å±¬æ€§çš„å°æ‡‰
	// ä¹‹å¾Œçµæœç¯©é¸æœƒç”¨åˆ°
	const categoryIcons = {};
	Object.keys(icons).forEach(type => {
		categoryIcons[type] = icons[type].options.iconUrl;
	});
	// çµæœé•·é€™æ¨£ï¼š
	// {
	//   arrow:      'https://cdn-icons-png.flaticon.com/512/4439/4439420.png',
	//   eat:        'https://cdn-icons-png.flaticon.com/512/1531/1531385.png',
	//   walk:       'https://cdn-icons-png.flaticon.com/512/2591/2591439.png',
	//   â€¦
	// }
	// 1. å®šç¾©ä¸€å€‹ FilterControlï¼ˆæ”¾å¤§é¡ + é¢æ¿ï¼‰
	const FilterControl = L.Control.extend({
		options: {
			position: 'topleft'
		}, // é¡¯ç¤ºåœ¨å·¦ä¸Šè§’
		onAdd(map) {
			// å®¹å™¨
			const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control filter-control');
			// æŒ‰éˆ•
			const btn = L.DomUtil.create('a', 'filter-btn', container);
			btn.href = '#';
			btn.title = 'ç¯©é¸åœ°é»';
			btn.innerHTML = 'ğŸ”';
			// é¢æ¿
			const panel = L.DomUtil.create('div', 'filter-panel hidden', container);
			// è¼¸å…¥æ¡†
			const input = L.DomUtil.create('input', '', panel);
			input.type = 'text';
			input.placeholder = 'è¼¸å…¥é—œéµå­—ç¯©é¸...';
			input.className = 'p-1 border rounded w-full box-border mb-3';
			// ç¯©é¸çµæœå®¹å™¨
			const results = L.DomUtil.create('div', 'filter-results space-y-4 text-gray-700 text-sm', panel);
			// é˜»æ­¢é»æ“Šäº‹ä»¶å†’æ³¡åˆ°åœ°åœ–
			L.DomEvent.disableClickPropagation(container);
			L.DomEvent.on(btn, 'click', e => {
			  L.DomEvent.stop(e);
			
			  // åˆ‡æ›ä¸€æ¬¡ hiddenï¼Œä¸¦å–å¾—æœ€æ–°ç‹€æ…‹
			  const nowHidden = panel.classList.toggle('hidden');
			
			  if (!nowHidden) {
			    // 1. å…ˆæŠŠé¢æ¿é¡¯ç¤ºå‡ºä¾†ï¼Œæ‰èƒ½è®€åˆ°å®ƒçš„ offsetWidth/offsetHeight
			    panel.style.visibility = 'hidden';
			    panel.style.display    = 'block';
			
			    const rect = btn.getBoundingClientRect();
			    const pw   = panel.offsetWidth;
			    const ph   = panel.offsetHeight;
			    const ww   = window.innerWidth;
			    const wh   = window.innerHeight;
			
			    // 2. è¨ˆç®—æ°´å¹³ä½ç½®ï¼šé è¨­æ”¾å³é‚Šï¼Œè‹¥è¶…å‡ºå°±æ”¹æ”¾å·¦é‚Š
			    let left = rect.right + 4;
			    if (left + pw > ww) {
			      left = rect.left - pw - 4;
			      if (left < 4) left = 4;   // æœ€å°‘ç•™ 4px é‚Šè·
			    }
			
			    // 3. è¨ˆç®—å‚ç›´ä½ç½®ï¼šé è¨­æ”¾ä¸‹æ–¹ï¼Œè‹¥è¶…å‡ºå°±æ”¹æ”¾ä¸Šæ–¹
			    let top = rect.bottom + 4;
			    if (top + ph > wh) {
			      top = rect.top - ph - 4;
			      if (top < 4) top = 4;     // æœ€å°‘ç•™ 4px é‚Šè·
			    }
			
			    // 4. å¥—ç”¨å®šä½ï¼Œæ¢å¾©å¯è¦–
			    Object.assign(panel.style, {
			      position:  'fixed',
			      left:      `${left}px`,
			      top:       `${top}px`,
			      transform: 'none',
			      visibility: 'visible'
			    });
			
			    input.focus();
			  }
			});
			// è™•ç†è¼¸å…¥å³æ™‚ç¯©é¸
			L.DomEvent.on(input, 'input', () => {
				const q = input.value.trim().toLowerCase();
				// æ ¹æ“š rows èˆ‡ markers, cardDivsï¼ˆéœ€äº‹å…ˆåœ¨å…¨åŸŸæˆ–ä¸Šå±¤ä½œç”¨åŸŸæº–å‚™å¥½é€™ä¸‰å€‹é™£åˆ—ï¼‰
				const groups = {};
				window.locdata.forEach((row, i) => {
					const title = row.title.toLowerCase();
					if (!q || title.includes(q)) {
						groups[row.type] = groups[row.type] || [];
						groups[row.type].push(i);
					}
				});
				// æ¸…ç©ºä¸¦æ¸²æŸ“çµæœ
				results.innerHTML = '';
				Object.entries(groups).forEach(([type, idxs]) => {
					const iconUrl = categoryIcons[type] || '';
					const det = document.createElement('details');
					det.open = true;
					det.innerHTML = `
	            <summary class="font-medium cursor-pointer">
		    	${iconUrl ? `<img src="${iconUrl}" class="category-icon" alt="${type} icon">`: ''} ${IconNameMaper(type)} (${idxs.length})
	            </summary>
	             <ul class="pl-4 list-disc">
		      ${idxs.map(i =>
		        `<li data-idx="${i}" style="cursor:pointer;">${window.locdata[i].title}</li>`
		      ).join('')}
		     </ul>`;
					results.appendChild(det);


  // ç¶å®šé»æ“Šé£›è½‰
  det.querySelectorAll('li').forEach(li => {
    li.addEventListener('click', () => {
      const idx = Number(li.dataset.idx);
      const row = window.locdata[idx];
      // é£›è½‰åˆ°è©² marker
      map.flyTo([row.lat, row.lng], isMobile ? 12 : 14, {
        duration: 0.8
      });
      // é¡¯ç¤ºè©²å¡ç‰‡
      showCard(idx);
      // åŒæ™‚éš±è—ç¯©é¸é¢æ¿
      panel.classList.add('hidden');
    });
  });

				});
				// åŒæ­¥åœ°åœ– Marker & å¡ç‰‡é¡¯ç¤º
				window.locdata.forEach((_, i) => {
					const match = Object.values(groups).flat().includes(i);
					// Marker
					if (match) window.locmarkers[i].addTo(map);
					else map.removeLayer(window.locmarkers[i]);
					// å¡ç‰‡
					const cardEl = document.getElementById(`card-${i}`);
					cardEl.style.display = match ? '' : 'none';
				});
			});
			// é€™è¡Œæœƒæ””æˆª panel ä¸Šçš„æ»¾è¼ªäº‹ä»¶ï¼Œä¸è®“å®ƒå¾€åœ°åœ–å‚³é
			L.DomEvent.disableScrollPropagation(container);
			return container;
		}
	});
	// æŠŠå‰›å‰›å»ºç«‹çš„ Control åŠ åˆ°åœ°åœ–
	map.addControl(new FilterControl());
	
	function createCard(card, index) {
		const cardDiv = document.createElement('div');
		cardDiv.className = 'story-card';
		cardDiv.id = `card-${index}`;
		// 2025.05.11 å–å¾—ç…§ç‰‡æ–¹å¼æ”¹ä»¥github workflow
		const owner = 'sm245735';
		const repo = 'confession-site';
		const branch = 'main';
		// Helperï¼šçµ¦å®š folderName è·Ÿ image æª”åï¼Œå›å‚³å®Œæ•´ raw URL
		function makeRawUrl(folderName, fileName) {
			let raw_url = `https://cdn.jsdelivr.net/gh/${owner}/${repo}@main/images/${encodeURIComponent(folderName)}/${encodeURIComponent(fileName)}`;
			// let raw_url = `./images/${encodeURIComponent(folderName)}/${encodeURIComponent(fileName)}`;	      
			return raw_url;
		}
		// æ‹‰å–åœ–ç‰‡æ¸…å–® JSON
		//const jsonUrl = `https://cdn.jsdelivr.net/gh/${owner}/${repo}@main/image-list/${encodeURIComponent(card.folderName)}.json`;
		const jsonUrl = `./image-list/${encodeURIComponent(card.folderName)}.json`;
		let imgs = '';
		fetch(jsonUrl).then(res => {
			if (!res.ok) throw new Error(`è®€å– JSON å¤±æ•— ${res.status}`);
			return res.json();
		}).then(files => {
			// æŠŠæª”åé™£åˆ—è½‰æˆ <div class="swiper-slide"><img â€¦></div> å­—ä¸²
			imgs = files.map(name => `<div class="swiper-slide">
		                         <img src="${makeRawUrl(card.folderName, name)}" class="w-full">
		                       </div>`).join('');
			cardDiv.innerHTML = `
		<div class="card-header p-4 flex justify-between items-center">
		    <h2 class="text-lg font-bold entry-title">
			<a href="javascript:;" onclick="if(confirm('ç¢ºå®šè¦å‰å¾€ï¼Ÿ')) window.open('${card.google_map_link}', '_blank')"
			   class="inline-flex items-center space-x-2"
			>
			<img src="https://cdn-icons-png.flaticon.com/512/1865/1865269.png" alt="ğŸ“Œ" class="ew-5 h-5 flex-shrink-0">
	                &nbsp;
			${card.title}
			</a>
		</h2>
		    <!-- æ”¶åˆæŒ‰éˆ• -->
		    <button class="toggle-btn text-gray-500 hover:text-gray-800 focus:outline-none" aria-expanded="true" aria-label="æ”¶åˆï¼å±•é–‹">
		       <span class="arrow">â–¼</span>
		    </button>
		  </div>
		<div class="card-body overflow-hidden transition-max-h duration-300 max-h-[1000px]">
	        	<div class="swiper">
		          <div class="swiper-wrapper">${imgs}</div>
	        	  <div class="swiper-pagination"></div>
		        </div>
	        	<div class="p-4">
	
		          <p class="text-sm text-gray-500" ${larger_style} >${card.time} | ${card.subtitle}</p>
	        	  <p class="mt-2 text-sm" ${larger_style}>${card.content}</p>
		        </div>
		</div>
	      `;
			document.getElementById('story-container').appendChild(cardDiv);
		});
	}
	
	function showCard(index) {
		document.querySelectorAll('.story-card').forEach(el => el.classList.remove('active'));
		const target = document.getElementById(`card-${index}`);
		if (target) target.classList.add('active');
	}
	fetch('./data/diary.csv').then(res => res.text()).then(csvText => {
		Papa.parse(csvText, {
			header: true,
			dynamicTyping: true,
			complete: function(results) {
				const rows = results.data.filter(r => r.lat && r.lng);
				window.locdata = rows;
				rows.forEach((row, index) => {
					const marker = L.marker([row.lat, row.lng], {
						icon: icons[row.type] || icons.walk
					}).addTo(map);
					window.locmarkers.push(marker)
					marker.on('click', () => showCard(index));
					createCard(row, index);
				});
				setTimeout(() => {
					document.querySelectorAll('.swiper').forEach(swiperEl => {
						new Swiper(swiperEl, {
							autoHeight: true, // è‡ªå‹•èª¿æ•´é«˜åº¦
							loop: true,
							pagination: {
								el: swiperEl.querySelector('.swiper-pagination')
							}
						});
					});
					showCard(0);
				}, 100);
			}
		});
	});
	// 1. åœ¨åˆå§‹åŒ–éšæ®µå°±åŠ ä¸€æ¬¡
	const container = document.getElementById('story-container');
	container.addEventListener('click', e => {
		// æ‰¾æœ€è¿‘çš„ toggle-btn ï¼ˆæ”¯æ´é»åˆ°è£¡é¢æ–‡å­—æ™‚ä¹Ÿèƒ½æŠ“åˆ°ï¼‰
		const btn = e.target.closest('.toggle-btn');
		if (!btn) return;
		// å†æ‰¾å‡ºé€™å€‹æŒ‰éˆ•çš„å¡ç‰‡èˆ‡å…§å®¹å€
		const card = btn.closest('.story-card');
		const body = card.querySelector('.card-body');
		const expanded = btn.getAttribute('aria-expanded') === 'true';
		if (expanded) {
			body.classList.add('max-h-0');
			btn.textContent = 'â–º';
			btn.setAttribute('aria-expanded', 'false');
		} else {
			body.classList.remove('max-h-0');
			btn.textContent = 'â–¼';
			btn.setAttribute('aria-expanded', 'true');
		}
	});
</script>
</body>
</html>

